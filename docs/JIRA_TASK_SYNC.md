# JIRA ↔ ERP 태스크·이슈 연동

프로젝트 단위로 JIRA와 ERP 태스크를 연동하는 방식과 설정을 설명합니다.

---

## 1. 연동 방향 (sync_direction)

각 프로젝트의 **이슈 연동**에서 다음 세 가지 중 하나를 선택할 수 있습니다.

| 방향 | 값 | 설명 |
|------|-----|------|
| **JIRA → ERP** | `jira_to_erp` | JIRA가 주 소스. JIRA에서 이슈를 작성·관리하고, 동기화 시 ERP 태스크로 가져옵니다. |
| **ERP → JIRA** | `erp_to_jira` | ERP가 주 소스. ERP에서 태스크를 작성·수정하면 자동으로 JIRA 이슈로 생성/갱신됩니다. |
| **양방향** | `bidirectional` | JIRA에서 가져오기 + ERP에서 수정/생성 시 JIRA에 반영. 두 시스템을 함께 사용할 때 사용합니다. |

---

## 2. “어디서 먼저 작성하나?”

### 2.1 JIRA → ERP (JIRA가 주)

- **먼저 작성하는 쪽**: **JIRA**
- **흐름**
  1. JIRA에서 프로젝트·이슈를 생성·관리
  2. ERP에서 해당 프로젝트에 JIRA 연동 설정 후 **「지금 동기화 (JIRA→ERP)」** 실행 (또는 `php artisan erp:sync-jira {project_id}`)
  3. JIRA 이슈가 ERP 태스크로 생성/갱신됨 (제목, 설명, 상태, 담당자, 마감일 등)
- **권장**: JIRA를 이미 일감 관리의 중심으로 쓰는 팀. ERP에서는 “프로젝트·태스크 보기·타임시트·비용”만 사용할 때.

### 2.2 ERP → JIRA (ERP가 주)

- **먼저 작성하는 쪽**: **ERP**
- **흐름**
  1. ERP에서 프로젝트·태스크를 생성·수정
  2. 해당 프로젝트에 JIRA 연동을 **ERP → JIRA** 또는 **양방향**으로 설정
  3. 태스크 저장 시 자동으로 JIRA 이슈가 생성되거나, 기존 연동 이슈가 수정됨
  4. (선택) JIRA에서도 **「지금 동기화」**로 JIRA 변경분을 ERP로 가져올 수 있는 건 **양방향**일 때만
- **권장**: ERP에서 일감을 먼저 쓰고, JIRA는 개발팀/외부와 공유용으로만 쓸 때.

### 2.3 양방향 (bidirectional)

- **먼저 작성하는 쪽**: **JIRA·ERP 둘 다 가능**
- **흐름**
  - **JIRA에서 먼저**: 이슈 작성 후 ERP에서 「지금 동기화」 → ERP 태스크 생성/갱신. 이후 ERP에서 수정하면 JIRA 이슈도 갱신됨.
  - **ERP에서 먼저**: 태스크 작성·수정 시 자동으로 JIRA 이슈 생성/갱신. JIRA에서 수정한 뒤 「지금 동기화」하면 ERP 태스크가 다시 갱신됨.
- **주의**
  - 같은 항목을 JIRA와 ERP에서 동시에 수정하면, **다음 동기화 시 한쪽이 덮어쓸 수 있습니다.** (현재는 “마지막 동기화/저장” 기준)
  - 충돌을 줄이려면: “이슈는 JIRA에서만 수정, ERP에서는 타임시트·비용만” 같은 규칙을 두는 것이 좋습니다.

---

## 3. 구현 요약

- **JIRA → ERP**
  - 프로젝트 연동 탭에서 **「지금 동기화 (JIRA→ERP)」** 버튼 또는 `php artisan erp:sync-jira {project_id}` 로 풀
  - JIRA 이슈 키(`external_id`)로 ERP 태스크와 1:1 매칭 후 생성/갱신
- **ERP → JIRA**
  - 태스크 생성/수정 시 `TaskObserver`에서 `JiraIntegrationService::pushToJira($task)` 호출
  - 연동 방향이 `erp_to_jira` 또는 `bidirectional` 이고, 해당 프로젝트 JIRA 연동이 활성일 때만 동작
- **양방향**
  - 위 두 동작 모두 사용: 수동 「지금 동기화」로 JIRA → ERP, 저장 시 자동으로 ERP → JIRA

---

## 4. 설정 위치

- **Filament**: 프로젝트 상세/편집 → **이슈 연동 (JIRA 등)** 탭
- **필수 입력**: JIRA URL, 프로젝트 키, 이메일, API 토큰 (Atlassian API 토큰)
- **선택**: 이슈 타입 ID (ERP에서 JIRA 이슈 생성 시 사용, 기본 10001)

---

## 5. 정리

| “어디서 먼저?” | 선택할 연동 방향 |
|----------------|------------------|
| JIRA에서만 이슈 작성하고 ERP에는 보기·타임시트용으로만 | **JIRA → ERP** |
| ERP에서만 태스크 작성하고 JIRA는 내보내기용 | **ERP → JIRA** |
| JIRA와 ERP 둘 다에서 작성·수정하고 서로 반영 | **양방향** (규칙 정리 권장) |
